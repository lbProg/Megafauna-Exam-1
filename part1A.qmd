---
title: "Sightings of North Pacific right whales (_Eubalaena japonica_)"
author:
    - Bastin Lucien
    - Fournil Lucie
date: 2025/09/10
knitr:
    opts_chunk: 
        message: false
        warning: false
format: html
fig-width: 12
fig-height: 7.5
lightbox: true
toc: true
toc-location: right-body
embed-resources: true
---

# Loading libraries

```{r}
library(dplyr)
library(ggplot2)
library(ggspatial)
library(lubridate)
library(rnaturalearth)
library(sf)
library(tidyr)
library(viridis)
```

# Question 1

*Collate the sighting data from Tables 1, 2 and 3 in a file for analysis in R, that is make them tidy data. Keep the datetime stamp, the geographic coordinates of the sightings along with the number of individuals sighted. Do not keep the other columns.*

The data is located in the "Data" folder as a `.csv` file.

# Question 2

*Load the data in R. Turn the data.frame into an sf object. Make a first plot of the sighting data. Add a land mask, a north arrow and a scale. Project the data to an appropriate coordinates reference system.*

Loading the sightings data, and a map layer for later.

```{r}
data_whale <- read.csv("Data/data_whale.csv")
world <- ne_countries(scale = "medium", returnclass = "sf")
```

Preview of the data :

```{r}
head(data_whale)
```

Turning the data into an sf object :

```{r}
data_whale_sf <- data_whale |>
  mutate(longitude = -longitude) |>
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) |>
  st_cast()
```

Plot of the sightings :

```{r}
#| fig-cap: Positions of the right whales sightings

plot_map <- function(whale_pos) {
  ggplot(whale_pos) +
    geom_sf(data = world) +
    geom_sf(
      data = whale_pos,
      aes(size = no_individuals),
      shape = 21,
      color = "red"
    ) +
    coord_sf(xlim = c(-105, -179), ylim = c(22, 73), expand = FALSE) +
    annotation_scale(location = "bl", width_hint = 0.25) +
    annotation_north_arrow(
      location = "bl",
      which_north = "true",
      pad_x = unit(0.2, "cm"),
      pad_y = unit(0.5, "cm"),
      style = north_arrow_fancy_orienteering
    ) +
    scale_size_continuous(range = c(2, 7)) +
    labs(
      x = "Longitude (°W)",
      y = "Latitude (°N)",
      size = "Number of\nindividuals"
    ) +
    theme_test()
}

map1 <- plot_map(data_whale_sf)

map1
```

# Question 3

*Change the format of date to a date object with package lubridate. Extract month and year as two new columns. Recode month into season with Dec-Jan-Feb as winter, March-April-May as spring, June-July-Aug as summer and Sept.-Oct.-Nov as autumn. Make a plot with four facets displaying the sightings for each season.*

Convert the `Date` column to a date object with package `lubridate` :

```{r}
data_whale_sf <- data_whale_sf |>
  mutate(date = as_date(ymd(date))) |> # Convert date to lubridate date object
  mutate(
    month = factor(month(date, label = TRUE, locale = "C", abbr = FALSE)),
    year = factor(year(date))
  ) # Extract month and year
```

Recode the month as season :

```{r}
month_season_table <- tribble(
  ~month, ~season,
  "January", "winter",
  "February", "winter",
  "March", "spring",
  "April", "spring",
  "May", "spring",
  "June", "summer",
  "July", "summer",
  "August", "summer",
  "September", "autumn",
  "October", "autumn",
  "November", "autumn",
  "December", "winter"
)

month_order <- c(
  "January", "February", "March", "April", "May", "June", "July", 
  "August", "September", "October", "November", "December"
)

data_whale_sf <- data_whale_sf |>
  left_join(month_season_table) |>
  mutate(
    season = factor(
      season,
      levels = c("spring", "summer", "autumn", "winter")
    ),
    month = factor(month, levels = month_order)
  )
```

Plot sightings by season :

```{r}
#| fig-cap: Positions of the sightings of right whales for each season

map2 <- plot_map(data_whale_sf) + facet_wrap(vars(season))

map2
```

# Question 4

*For each month, compute the average location of all sightings in the data. You will need to work on the projected coordinates and extract (hint: use st_coordinates()) them before averaging. Plot the resulting average locations using a color code for each month. What does this map suggest with respect to where right whales are throughout a year ?*

Average location of sightings per month :

```{r}
data_whale_sf <- data_whale_sf |>
  mutate(
    lon = st_coordinates(geometry)[, 1],
    lat = st_coordinates(geometry)[, 2]
  ) |>
  group_by(month) |>
  mutate(mean_lon = mean(lon), mean_lat = mean(lat))
```

Add average locations by month to the map :

```{r}
#| fig-cap: Average position of right whale sightings by month, divided between seasons.

month_paths <- data_whale_sf |>
  group_by(month) |>
  reframe(across(c(mean_lon, mean_lat), mean)) |>
  mutate(xend = lead(mean_lon), yend = lead(mean_lat))

map3 <- plot_map(data_whale_sf) +
  geom_segment(
    data = month_paths,
    aes(
      x = mean_lon,
      y = mean_lat,
      xend = lead(mean_lon),
      yend = lead(mean_lat)
    ),
    arrow = arrow(length = unit(0.30, "cm"), ends = "last", type = "closed"),
    alpha = 0.6
  ) +
  geom_point(
    data = data_whale_sf,
    aes(x = mean_lon, y = mean_lat, color = month),
    shape = 18,
    size = 4
  ) +
  scale_color_viridis_d() +
  labs(color = "Month")

map3
```

Based on these data, it appears that right whales migrate northwards during spring and summer, leaving the southern US coasts to reach Alaska where they spend the summer and autumn. During the winter, the whales travel back to the south.

# Question 5

*For each year, summarize the data with respect to the number of sightings and the number of individuals seen. Plot these data as two time series on the same plot. What does this plot suggest? Do you think this is a true signal? If not, what could it mean ?*

Summarize number of sightings and number of individuals by year :

```{r}
data_whale_summary <- data_whale_sf |>
  st_drop_geometry() |>
  group_by(date = floor_date(date, "year")) |>
  summarize(sightings = n(), total_ind = sum(no_individuals)) |>
  pivot_longer(
    cols = c(sightings, total_ind),
    names_to = "measure",
    values_to = "value"
  )
```

Plotting the data :

```{r}
#| fig-cap: Time series of the number of sightings and total number of right whales seen each year
#| fig-width: 8
#| fig-height: 6

ggplot(
  data_whale_summary,
  aes(x = date, y = value, color = measure, group = measure)
) +
  geom_point() +
  geom_line() +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(breaks = seq(0, 55, 5)) +
  scale_color_discrete(labels = c("Total sightings", "Total individuals")) +
  labs(x = "Year", y = "Value", color = "Measure") +
  theme_bw()
```

The number of sightings and the number of individuals are highly correlated and vary in the same way across years. This relationship is expected, since the more individuals there are, the more sightings we are likely to obtain. However, it may also reflect changes in observation effort (number of boats, opportunistic records, etc.).

To confirm that the pattern reflects real fluctuations in population size rather than effort, the number of individuals should be corrected for observation effort each year.